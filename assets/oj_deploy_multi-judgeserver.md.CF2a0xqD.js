import{_ as s,c as i,o as a,a3 as n}from"./chunks/framework.ZS1GtFyN.js";const E=JSON.parse('{"title":"多个判题机","description":"","frontmatter":{},"headers":[],"relativePath":"oj/deploy/multi-judgeserver.md","filePath":"oj/deploy/multi-judgeserver.md","lastUpdated":null}'),l={name:"oj/deploy/multi-judgeserver.md"},p=n(`<h1 id="多个判题机" tabindex="-1">多个判题机 <a class="header-anchor" href="#多个判题机" aria-label="Permalink to &quot;多个判题机&quot;">​</a></h1><h2 id="前言" tabindex="-1">前言 <a class="header-anchor" href="#前言" aria-label="Permalink to &quot;前言&quot;">​</a></h2><p>不同判题机之间是通过rsync进行数据同步的，所以需要配置相应的rsync服务。</p><p>同时注意以下两点：</p><ol><li>保证rsync-slave服务的密码与主服务rsync-master的数据同步密码一致</li><li>rsync-slave服务（判题机服务器）拉取主服务rsync-master的评测数据是每100s一次，所以后台上传评测数据后，需等待大概100s才能正常判题。</li></ol><h2 id="单体部署" tabindex="-1">单体部署 <a class="header-anchor" href="#单体部署" aria-label="Permalink to &quot;单体部署&quot;">​</a></h2><p>如果之前是选择了单体部署，也就是主服务器既有backend和judgeserver服务，那么部署更多不同服务器的判题机应该如下修改：</p><ol><li><p>在原先运行的服务器上，修改<code>hoj-deploy/standAlone</code>文件夹里面的<code>docker-compose.yml</code>，<strong>添加以下rsync-master服务</strong>，数据同步密码请自行修改，如下：</p><p><strong>（注意：如果云服务器有防火墙请开启8848，3306，873端口）</strong></p><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">hoj-rsync-master</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    image</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">registry.cn-shenzhen.aliyuncs.com/hcode/hoj_rsync:1.0</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    container_name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">hoj-rsync-master</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    volumes</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      - </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">./hoj/testcase:/hoj/testcase:ro</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    environment</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      - </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">RSYNC_MODE=master</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      - </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">RSYNC_USER=hojrsync</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      - </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">RSYNC_PASSWORD=hoj123456</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> # 请修改数据同步密码</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    ports</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      - </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;0.0.0.0:873:873&quot;</span></span></code></pre></div><p><strong>同时，需要将MySQL的配置<code>MYSQL_PUBLIC_HOST</code>改成当前服务器的公网IP</strong></p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">vim</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> .env</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  # 修改与docker-compose.yml同目录下的配置文件</span></span></code></pre></div><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># mysql的配置</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">MYSQL_HOST=172.20.0.3</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 请提供当前mysql所在服务器的公网ip</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">MYSQL_PUBLIC_HOST=***</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">MYSQL_PUBLIC_PORT=3306</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">MYSQL_ROOT_PASSWORD=hoj123456</span></span></code></pre></div><p>修改完保存，然后重启docker即可生效</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">docker-compose</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> down</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">docker-compose</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> up</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -d</span></span></code></pre></div></li><li><p>在其它服务器（判题机服务器）中使用docker-compose运行judgeserver服务，具体操作如下：</p><p><strong>（注意：如果云服务器有防火墙请开启8088端口号，需要将判题服务暴露出去）</strong></p><ol><li><p>下载文件,进入到指定文件夹</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">git</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> clone</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> https://gitee.com/himitzh0730/hoj-deploy.git</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> &amp;&amp; </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">cd</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> hoj-deploy/distributed/judgeserver</span></span></code></pre></div></li><li><p>修改配置<code>.env</code>文件。</p><p>重点按照提示修改这些配置项：</p><ul><li><code>NACOS_HOST</code>：<strong>修改为nacos所在服务的ip，一般就是主服务器的ip</strong></li><li><code>NACOS_PORT</code> ：<strong>修改为nacos启动端口号，默认为8848</strong></li><li><code>NACOS_USERNAME</code>：<strong>修改为nacos的管理员账号</strong></li><li><code>NACOS_PASSWORD</code>：<strong>修改为nacos的管理员密码</strong></li><li><code>JUDGE_SERVER_IP</code>：<strong>提供当前判题机服务器的公网ip</strong></li><li><code>RSYNC_MASTER_ADDR</code>：<strong>修改为主服务器的ip</strong></li><li><code>RSYNC_PASSWORD</code>：<strong>在主服务配置rsync的密码</strong></li></ul><p><strong>其他配置项详情请按照文件内提示进行修改</strong></p><div class="language-properties vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">properties</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># nacos的配置</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 修改为nacos所在服务的ip</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">NACOS_HOST</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">=NACOS_HOST</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 修改为nacos启动端口号，默认为8848</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">NACOS_PORT</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">=8848</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 修改为nacos的管理员账号</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">NACOS_USERNAME</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">=root</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 修改为nacos的管理员密码</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">NACOS_PASSWORD</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">=hoj123456</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># judgeserver的配置</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">#修改为当前服务器公网ip</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">JUDGE_SERVER_IP</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">=172.20.0.7</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">JUDGE_SERVER_PORT</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">=8088</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">JUDGE_SERVER_NAME</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">=judger-1</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># -1表示可接收最大判题任务数为cpu核心数+1</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">MAX_TASK_NUM</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">=-1</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 当前判题服务器是否开启远程虚拟判题功能</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">REMOTE_JUDGE_OPEN</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">=true</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># -1表示可接收最大远程判题任务数为cpu核心数*2+1</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">REMOTE_JUDGE_MAX_TASK_NUM</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">=-1</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 默认沙盒并行判题程序数为cpu核心数</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">PARALLEL_TASK</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">=default</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># rsync评测数据同步的配置</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 写入主服务器ip</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">RSYNC_MASTER_ADDR</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">=127.0.0.1</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 与主服务器的rsync密码一致</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">RSYNC_PASSWORD</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">=hoj123456</span></span></code></pre></div></li><li><p>启动即可</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">docker-compose</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> up</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -d</span></span></code></pre></div></li><li><p>验证：</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span>访问 http://ip:8088/version</span></span>
<span class="line"><span>	  如果返回信息正常即启动成功！</span></span></code></pre></div></li></ol></li></ol><h2 id="分布式部署" tabindex="-1">分布式部署 <a class="header-anchor" href="#分布式部署" aria-label="Permalink to &quot;分布式部署&quot;">​</a></h2><ol><li><p>如果之前已经选择了分布式部署，那么增加判题机，则与原先启动判题机的操作一样即可，在新的服务器上操作如下：</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">git</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> clone</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> https://gitee.com/himitzh0730/hoj-deploy.git</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> &amp;&amp; </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">cd</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> hoj-deploy/distributed/judgeserver</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">vim</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> .env</span></span></code></pre></div></li><li><p>修改<code>.env</code>文件的配置</p><p>重点按照提示修改这些配置项：</p><ul><li><code>NACOS_HOST</code>：<strong>修改为nacos所在服务的ip，一般就是主服务器的ip</strong></li><li><code>NACOS_PORT</code> ：<strong>修改为nacos启动端口号，默认为8848</strong></li><li><code>NACOS_USERNAME</code>：<strong>修改为nacos的管理员账号</strong></li><li><code>NACOS_PASSWORD</code>：<strong>修改为nacos的管理员密码</strong></li><li><code>JUDGE_SERVER_IP</code>：<strong>提供当前判题机服务器的公网ip</strong></li><li><code>RSYNC_MASTER_ADDR</code>：<strong>修改为主服务器的ip</strong></li><li><code>RSYNC_PASSWORD</code>：<strong>在主服务配置rsync的密码</strong></li></ul><p><strong>其他配置项详情请按照文件内提示进行修改</strong></p><div class="language-properties vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">properties</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># nacos的配置</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 修改为nacos所在服务的ip</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">NACOS_HOST</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">=NACOS_HOST</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 修改为nacos启动端口号，默认为8848</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">NACOS_PORT</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">=8848</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 修改为nacos的管理员账号</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">NACOS_USERNAME</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">=root</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 修改为nacos的管理员密码</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">NACOS_PASSWORD</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">=hoj123456</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># judgeserver的配置</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">#修改为当前服务器公网ip</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">JUDGE_SERVER_IP</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">=172.20.0.7</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">JUDGE_SERVER_PORT</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">=8088</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">JUDGE_SERVER_NAME</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">=judger-1</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># -1表示可接收最大判题任务数为cpu核心数+1</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">MAX_TASK_NUM</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">=-1</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 当前判题服务器是否开启远程虚拟判题功能</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">REMOTE_JUDGE_OPEN</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">=true</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># -1表示可接收最大远程判题任务数为cpu核心数*2+1</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">REMOTE_JUDGE_MAX_TASK_NUM</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">=-1</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 默认沙盒并行判题程序数为cpu核心数</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">PARALLEL_TASK</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">=default</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># rsync评测数据同步的配置</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 写入主服务器ip</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">RSYNC_MASTER_ADDR</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">=127.0.0.1</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 与主服务器的rsync密码一致</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">RSYNC_PASSWORD</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">=hoj123456</span></span></code></pre></div></li><li><p>修改完保存，启动即可。</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">docker-compose</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> up</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -d</span></span></code></pre></div></li></ol>`,10),e=[p];function h(t,k,d,r,c,o){return a(),i("div",null,e)}const y=s(l,[["render",h]]);export{E as __pageData,y as default};
